<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>nunc — explore</title>
  <link rel="stylesheet" href="./assets/app.css">
  <style>
    .shell{
      width:100%;
      border:1px solid var(--hair);
      background:var(--panel);
      border-radius:0;
      overflow:hidden;
    }

    .shell-header{
      padding:18px 18px 14px;
      border-bottom:1px solid var(--hair);
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
    }

    .shell-title{
      font-size:22px;
      font-weight:600;
      margin:0;
      letter-spacing:0.1px;
    }

    .tools{
      padding:14px 18px;
      border-bottom:1px solid var(--hair);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .search{
      flex:1 1 260px;
      display:flex;
      gap:10px;
      align-items:center;
      min-width:240px;
    }

    .search input{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--hair);
      background:rgba(255,255,255,0.03);
      color:var(--text);
      font:inherit;
      outline:none;
    }

    .btn-sm{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--hair);
      background:rgba(255,255,255,0.03);
      color:var(--text);
      font:inherit;
      cursor:pointer;
    }

    .btn-sm:hover{background:var(--pill);}

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      padding:14px 18px 18px;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns: repeat(2, minmax(0, 1fr));}
    }
    @media (max-width: 560px){
      .grid{grid-template-columns: 1fr;}
      .shell-header{padding:16px 14px 12px;}
      .tools{padding:12px 14px;}
      .grid{padding:12px 14px 14px;}
    }

    .card{
      border:1px solid var(--hair);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border-radius:16px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:120px;
    }

    .card-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px 10px;
      border-bottom:1px solid var(--hair);
      align-items:center;
    }

    .country{
      font-weight:700;
      letter-spacing:0.2px;
    }

    .score{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size:13px;
      white-space:nowrap;
    }

    .score strong{color:var(--text);}

    .card-body{
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .bar{
      height:10px;
      border-radius:999px;
      border:1px solid var(--hair);
      background:rgba(255,255,255,0.03);
      overflow:hidden;
    }

    .bar > div{
      height:100%;
      width:0%;
      background:var(--goldBg);
    }

    .mini{
      font-size:12px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.82);
      border:1px solid var(--hair);
      padding:10px 12px;
      border-radius:12px;
      display:none;
      z-index:60;
    }

    .statusline{
      padding:12px 18px;
      border-top:1px solid var(--hair);
      color:var(--muted);
      font-size:13px;
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }

    .spinner{
      width:14px;
      height:14px;
      border-radius:999px;
      border:2px solid var(--hair);
      border-top-color:rgba(255,255,255,0.55);
      animation:spin 0.8s linear infinite;
      display:none;
    }
    .loading .spinner{display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}
  </style>
  <script src="./assets/app.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="nav">
        <div class="brand">
          <a class="logo" href="./index.html">nunc</a>
        </div>
        <div class="nav-actions">
          <a class="pill" href="./index.html">leaderboard</a>
          <a class="pill" href="./explore.html">explore</a>
          <a class="pill" href="./post.html">post</a>
          <a class="pill" href="./login.html">log in</a>
        </div>
      </div>
    </header>

    <main>
      <section class="shell" aria-label="Explore">
        <div class="shell-header">
          <h2 class="shell-title">Explore</h2>
        </div>

        <div class="tools">
          <div class="search">
            <input id="q" placeholder="Search country…" autocomplete="off" />
          </div>
          <button class="btn-sm" id="clearBtn" type="button">Clear</button>
          <button class="btn-sm" id="randomBtn" type="button">Random</button>
        </div>

        <div id="grid" class="grid"></div>

        <div class="statusline" id="statusLine">
          <div style="display:flex;align-items:center;gap:10px;">
            <span class="spinner" aria-hidden="true"></span>
            <span id="statusText">Loaded</span>
          </div>
          <span id="statusMeta">—</span>
        </div>
      </section>
    </main>

    <footer>
      <div class="foot">
        <div>© nunc</div>
        <div>terms · transparency · ledger</div>
      </div>
    </footer>
  </div>

  <div class="toast" id="toast"></div>

  <script>
  (() => {
    'use strict';

    if (!window.NUNC) {
      console.error('NUNC runtime missing: include ./assets/app.js before this script.');
      return;
    }

    const Q = document.getElementById('q');
    const GRID = document.getElementById('grid');
    const CLEAR = document.getElementById('clearBtn');
    const RANDOM = document.getElementById('randomBtn');
    const TOAST = document.getElementById('toast');
    const STATUSLINE = document.getElementById('statusLine');
    const STATUS_TEXT = document.getElementById('statusText');
    const STATUS_META = document.getElementById('statusMeta');

    const toastMsg = (m) => {
      TOAST.textContent = m;
      TOAST.style.display = 'block';
      setTimeout(() => TOAST.style.display = 'none', 1600);
    };

    const setLoading = (on) => {
      if (on) STATUSLINE.classList.add('loading');
      else STATUSLINE.classList.remove('loading');
    };

    const norm = (s) => String(s || '').trim().toLowerCase();
    const clamp = (n, a, b) => Math.max(a, Math.min(b, n));

    let lastLedgerPosts = [];
    let lastTotals = null;
    let lastSortedCountries = [];

    function card(country, total, maxTotal){
      const el = document.createElement('div');
      el.className = 'card';

      const top = document.createElement('div');
      top.className = 'card-top';

      const c = document.createElement('div');
      c.className = 'country';
      c.textContent = country;

      const s = document.createElement('div');
      s.className = 'score';
      s.innerHTML = `<span>boosts</span> <strong>${Number(total || 0)}</strong>`;

      top.appendChild(c);
      top.appendChild(s);

      const body = document.createElement('div');
      body.className = 'card-body';

      const bar = document.createElement('div');
      bar.className = 'bar';
      const fill = document.createElement('div');
      const pct = maxTotal > 0 ? clamp((Number(total || 0) / maxTotal) * 100, 0, 100) : 0;
      fill.style.width = pct.toFixed(1) + '%';
      bar.appendChild(fill);

      const mini = document.createElement('div');
      mini.className = 'mini';

      const postsCount = lastLedgerPosts.filter(p => String(p.country || '').trim() === country).length;
      mini.innerHTML = `<span>${postsCount} posts</span><span>${pct.toFixed(1)}%</span>`;

      body.appendChild(bar);
      body.appendChild(mini);

      el.appendChild(top);
      el.appendChild(body);

      return el;
    }

    function render(filterText){
      const ft = norm(filterText);
      const list = ft
        ? lastSortedCountries.filter(c => norm(c).includes(ft))
        : lastSortedCountries;

      GRID.innerHTML = '';

      if (!list.length) {
        const empty = document.createElement('div');
        empty.className = 'card';
        empty.innerHTML = `
          <div class="card-top"><div class="country">No results</div><div class="score"><span>—</span></div></div>
          <div class="card-body"><div class="mini">Try a different search.</div></div>
        `;
        GRID.appendChild(empty);
        STATUS_META.textContent = '0 countries';
        return;
      }

      const totals = lastTotals || window.NUNC.totalsByCountry(lastLedgerPosts);
      const maxTotal = Math.max(0, ...Object.values(totals).map(v => Number(v || 0)));

      const frag = document.createDocumentFragment();
      for (const c of list) {
        frag.appendChild(card(c, totals[c] || 0, maxTotal));
      }
      GRID.appendChild(frag);

      STATUS_META.textContent = `${list.length} countries`;
    }

    async function refresh(authoritative){
      setLoading(true);
      try{
        // Fast paint from cache if desired
        if (!authoritative) {
          try{
            const cached = await window.NUNC.getLedger({ preferCache: true });
            lastLedgerPosts = cached.posts || [];
            lastTotals = window.NUNC.totalsByCountry(lastLedgerPosts);
            lastSortedCountries = window.NUNC.sortCountriesByTotals(lastTotals);
            render(Q.value);
          }catch(_){}
        }

        // Authoritative API fetch
        const ledger = await window.NUNC.getLedger();
        lastLedgerPosts = ledger.posts || [];
        lastTotals = window.NUNC.totalsByCountry(lastLedgerPosts);
        lastSortedCountries = window.NUNC.sortCountriesByTotals(lastTotals);

        STATUS_TEXT.textContent = `Loaded ${lastLedgerPosts.length} posts`;
        render(Q.value);
      }catch(_){
        toastMsg('Load failed (API unreachable).');
      }finally{
        setLoading(false);
      }
    }

    // Search + buttons
    Q.addEventListener('input', () => render(Q.value));
    CLEAR.addEventListener('click', () => { Q.value=''; render(''); });
    RANDOM.addEventListener('click', () => {
      const c = window.NUNC.rand(window.NUNC.COUNTRIES);
      Q.value = c;
      render(Q.value);
    });

    // Initial: cache -> API
    refresh(false);

    // Debounced refresh on ledger events
    let t = null;
    const scheduleRefresh = () => {
      clearTimeout(t);
      t = setTimeout(() => refresh(true), 180);
    };

    window.NUNC.watchLedger(() => scheduleRefresh(), { pollMs: 1100 });
  })();
  </script>
</body>
</html>
