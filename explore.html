<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>nunc — explore</title>
  <link rel="stylesheet" href="./assets/app.css">
  <style>
    .shell{
      width:100%;
      border:1px solid var(--hair);
      background:var(--panel);
      border-radius:0;
      overflow:hidden;
    }

    .shell-header{
      padding:18px 18px 14px;
      border-bottom:1px solid var(--hair);
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
    }

    .shell-title{
      font-size:22px;
      font-weight:600;
      margin:0;
      letter-spacing:0.1px;
    }

    .shell-sub{
      font-size:13px;
      color:var(--muted);
      letter-spacing:0.6px;
      text-transform:uppercase;
      white-space:nowrap;
    }

    .tools{
      padding:14px 18px;
      border-bottom:1px solid var(--hair);
      background:linear-gradient(to bottom, rgba(0,0,0,0.08), rgba(0,0,0,0));
      display:flex;
      flex-direction:column;
      gap:10px;
    }

    .searchRow{display:flex;gap:10px;align-items:center;flex-wrap:wrap;}

    .search{
      flex:1;
      min-width:260px;
      display:flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border:1px solid var(--hair);
      border-radius:14px;
      background:rgba(255,255,255,0.03);
    }

    .searchIcon{color:var(--muted);font-size:16px;line-height:1;user-select:none;}

    input[type="text"]{
      width:100%;
      border:0;
      outline:none;
      background:transparent;
      color:var(--text);
      font-size:16px;
      font-family:inherit;
      letter-spacing:0.2px;
    }

    input::placeholder{color:rgba(255,255,255,0.45)}

    .hint{font-size:13px;color:var(--muted);line-height:1.35;}

    .results{display:flex;flex-direction:column}

    .row{
      display:grid;
      grid-template-columns: 1fr 120px;
      gap:14px;
      padding:14px 18px;
      border-bottom:1px solid var(--hair);
      align-items:center;
      cursor:pointer;
    }

    .row:last-child{border-bottom:none}

    .country{
      font-size:18px;
      font-weight:600;
      line-height:1.2;
      word-wrap:break-word;
      overflow-wrap:anywhere;
    }

    .meta{
      font-size:13px;
      color:var(--muted);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:6px;
    }

    .dot{
      width:3px;
      height:3px;
      border-radius:999px;
      background:var(--muted);
      opacity:0.6;
      display:inline-block;
      transform:translateY(-1px);
    }

    .go{
      justify-self:end;
      padding:9px 12px;
      border:1px solid var(--hair);
      border-radius:12px;
      background:transparent;
      color:var(--muted);
      font-family:inherit;
      font-size:14px;
      cursor:pointer;
      user-select:none;
    }

    .go:hover{color:var(--text);background:var(--pill)}

    .empty{padding:18px;color:var(--muted);font-size:13px}
  </style>
  <script src="./assets/app.js"></script>
</head>
<body>
<div class="wrap">
  <header>
    <div class="nav">
      <div class="brand"><a class="logo" href="index.html">nunc</a></div>
      <div class="nav-actions">
        <a class="pill" href="index.html">leaderboard</a>
        <a class="pill" href="explore.html">explore</a>
        <a class="pill" href="post.html">post</a>
        <a class="pill" href="login.html">log in</a>
      </div>
    </div>
  </header>

  <main>
    <section class="shell">
      <div class="shell-header">
        <h2 class="shell-title">Most boosted nation</h2>
        <div class="shell-sub">Ranked by total boosts</div>
      </div>

      <div class="tools">
        <div class="searchRow">
          <div class="search">
            <div class="searchIcon">⌕</div>
            <input id="q" type="text" placeholder="Search countries" autocomplete="off" />
          </div>
        </div>
        <div class="hint">Ranking uses boosts from posts created in <code>post.html</code> and boosted in <code>index.html</code> (API-backed shared ledger).</div>
      </div>

      <div id="results" class="results"></div>
      <div id="empty" class="empty" style="display:none">No matches.</div>
    </section>
  </main>

  <footer>
    <div class="foot">
      <div>© nunc</div>
      <div>terms · transparency · ledger</div>
    </div>
  </footer>
</div>

<script>
(() => {
  'use strict';

  if (!window.NUNC) {
    console.error('NUNC runtime missing: include ./assets/app.js before this script.');
    return;
  }

  const Q = document.getElementById('q');
  const RESULTS = document.getElementById('results');
  const EMPTY = document.getElementById('empty');

  const norm = (s) => String(s || '').trim().toLowerCase();

  let ledgerPosts = [];
  let totals = Object.create(null);      // { country: boosts }
  let order = [];                       // [country,...] sorted DESC by boosts
  let rankMap = Object.create(null);    // { country: rank }

  function rebuildRankMap(){
    rankMap = Object.create(null);
    for (let i = 0; i < order.length; i++) rankMap[order[i]] = i + 1;
  }

  function countPostsByCountry(posts){
    const m = Object.create(null);
    for (const c of (window.NUNC.COUNTRIES || [])) m[c] = 0;
    for (const p of posts){
      const c = String(p?.country || '').trim();
      if (!c) continue;
      m[c] = (m[c] || 0) + 1;
    }
    return m;
  }

  function render(list){
    RESULTS.innerHTML = '';
    if (!list.length){
      EMPTY.style.display = 'block';
      return;
    }
    EMPTY.style.display = 'none';

    const postsCount = countPostsByCountry(ledgerPosts);
    const frag = document.createDocumentFragment();

    for (const c of list){
      const r = document.createElement('div');
      r.className = 'row';

      const left = document.createElement('div');

      const title = document.createElement('div');
      title.className = 'country';
      title.textContent = `#${rankMap[c] || '—'} — ${c}`;

      const meta = document.createElement('div');
      meta.className = 'meta';

      const total = Number(totals[c] || 0);
      const pc = Number(postsCount[c] || 0);

      meta.innerHTML = `<span>${total} boosts</span><span class="dot"></span><span>${pc} posts</span>`;

      left.appendChild(title);
      left.appendChild(meta);

      const go = document.createElement('button');
      go.className = 'go';
      go.type = 'button';
      go.textContent = 'open';
      go.addEventListener('click', (e) => {
        e.stopPropagation();
        location.href = `map.html?country=${encodeURIComponent(c)}`;
      });

      r.appendChild(left);
      r.appendChild(go);

      r.addEventListener('click', () => {
        location.href = `map.html?country=${encodeURIComponent(c)}`;
      });

      frag.appendChild(r);
    }

    RESULTS.appendChild(frag);
  }

  function filter(){
    const q = norm(Q.value);
    if (!q) { render(order); return; }
    render(order.filter(c => norm(c).includes(q)));
  }

  function recomputeFrom(posts){
    ledgerPosts = posts || [];
    totals = window.NUNC.totalsByCountry(ledgerPosts);

    // primary: total boosts desc, tie-break: alphabetical
    order = window.NUNC.sortCountriesByTotals(totals).slice();
    order.sort((a,b) => {
      const ta = Number(totals[a] || 0);
      const tb = Number(totals[b] || 0);
      if (tb !== ta) return tb - ta;
      return String(a).localeCompare(String(b));
    });

    rebuildRankMap();
  }

  async function refresh(){
    try{
      const ledger = await window.NUNC.getLedger();
      recomputeFrom(ledger.posts || []);
      filter();
    }catch(e){
      // keep last good render; no UI chrome added
      console.warn('Explore refresh failed', e);
    }
  }

  Q.addEventListener('input', filter);

  // Initial load
  refresh();

  // Live updates (cross-tab + polling handled in app.js)
  let t = null;
  const schedule = () => {
    clearTimeout(t);
    t = setTimeout(refresh, 160);
  };
  window.NUNC.watchLedger(() => schedule(), { pollMs: 1100 });

})();
</script>
</body>
</html>
