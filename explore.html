<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>nunc — explore</title>
  <link rel="stylesheet" href="./assets/app.css">
  <style>
    .shell{
      width:100%;
      border:1px solid var(--hair);
      background:var(--panel);
      border-radius:0;
      overflow:hidden;
    }

    .shell-header{
      padding:18px 18px 14px;
      border-bottom:1px solid var(--hair);
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
    }

    .shell-title{
      font-size:22px;
      font-weight:600;
      margin:0;
      letter-spacing:0.1px;
    }

    .tools{
      padding:14px 18px;
      border-bottom:1px solid var(--hair);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }

    .search{
      flex:1 1 260px;
      display:flex;
      gap:10px;
      align-items:center;
      min-width:240px;
    }

    .search input{
      width:100%;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--hair);
      background:rgba(255,255,255,0.03);
      color:var(--text);
      font:inherit;
      outline:none;
    }

    .btn-sm{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--hair);
      background:rgba(255,255,255,0.03);
      color:var(--text);
      font:inherit;
      cursor:pointer;
    }
    .btn-sm:hover{background:var(--pill);}

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:12px;
      padding:14px 18px 18px;
    }

    @media (max-width: 980px){
      .grid{grid-template-columns: repeat(2, minmax(0, 1fr));}
    }
    @media (max-width: 560px){
      .grid{grid-template-columns: 1fr;}
      .shell-header{padding:16px 14px 12px;}
      .tools{padding:12px 14px;}
      .grid{padding:12px 14px 14px;}
    }

    .card{
      border:1px solid var(--hair);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border-radius:16px;
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:96px;
    }

    .card-top{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding:12px 12px 10px;
      border-bottom:1px solid var(--hair);
      align-items:center;
    }

    .left{
      display:flex;
      align-items:baseline;
      gap:10px;
      min-width:0;
    }

    .rank{
      font-variant-numeric: tabular-nums;
      color:var(--muted);
      font-size:13px;
      white-space:nowrap;
    }

    .country{
      font-weight:700;
      letter-spacing:0.2px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .score{
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--muted);
      font-size:13px;
      white-space:nowrap;
    }
    .score strong{color:var(--text);}

    .card-body{
      padding:10px 12px 12px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      color:var(--muted);
      font-size:12px;
    }

    .muted{color:var(--muted);}

    /* remove the old bar/status UI entirely (kept no-op classes in case app.css references) */
    .bar, .statusline, .spinner, .toast{display:none !important;}
  </style>
  <script src="./assets/app.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="nav">
        <div class="brand">
          <a class="logo" href="./index.html">nunc</a>
        </div>
        <div class="nav-actions">
          <a class="pill" href="./index.html">leaderboard</a>
          <a class="pill" href="./explore.html">explore</a>
          <a class="pill" href="./post.html">post</a>
          <a class="pill" href="./login.html">log in</a>
        </div>
      </div>
    </header>

    <main>
      <section class="shell" aria-label="Explore">
        <div class="shell-header">
          <h2 class="shell-title">Explore</h2>
        </div>

        <div class="tools">
          <div class="search">
            <input id="q" placeholder="Search country…" autocomplete="off" />
          </div>
          <button class="btn-sm" id="clearBtn" type="button">Clear</button>
          <button class="btn-sm" id="randomBtn" type="button">Random</button>
        </div>

        <div id="grid" class="grid"></div>
      </section>
    </main>

    <footer>
      <div class="foot">
        <div>© nunc</div>
        <div>terms · transparency · ledger</div>
      </div>
    </footer>
  </div>

  <script>
  (() => {
    'use strict';

    if (!window.NUNC) {
      console.error('NUNC runtime missing: include ./assets/app.js before this script.');
      return;
    }

    const Q = document.getElementById('q');
    const GRID = document.getElementById('grid');
    const CLEAR = document.getElementById('clearBtn');
    const RANDOM = document.getElementById('randomBtn');

    const norm = (s) => String(s || '').trim().toLowerCase();

    let lastLedgerPosts = [];
    let lastTotals = null;            // { country: boosts }
    let lastSortedCountries = [];     // [country,...] sorted DESC by boosts

    function postsCountFor(country){
      // cheap O(n) is fine for demo; can precompute if needed
      let n = 0;
      for (const p of lastLedgerPosts) if (String(p.country || '').trim() === country) n++;
      return n;
    }

    function card(rank, country, total){
      const el = document.createElement('div');
      el.className = 'card';

      const top = document.createElement('div');
      top.className = 'card-top';

      const left = document.createElement('div');
      left.className = 'left';

      const r = document.createElement('div');
      r.className = 'rank';
      r.textContent = `#${rank}`;

      const c = document.createElement('div');
      c.className = 'country';
      c.textContent = country;

      left.appendChild(r);
      left.appendChild(c);

      const s = document.createElement('div');
      s.className = 'score';
      s.innerHTML = `<span>boosts</span> <strong>${Number(total || 0)}</strong>`;

      top.appendChild(left);
      top.appendChild(s);

      const body = document.createElement('div');
      body.className = 'card-body';

      const pc = document.createElement('div');
      pc.className = 'muted';
      pc.textContent = `${postsCountFor(country)} posts`;

      const hint = document.createElement('div');
      hint.className = 'muted';
      hint.textContent = 'ranked';

      body.appendChild(pc);
      body.appendChild(hint);

      el.appendChild(top);
      el.appendChild(body);

      return el;
    }

    function render(filterText){
      const ft = norm(filterText);
      const list = ft
        ? lastSortedCountries.filter(c => norm(c).includes(ft))
        : lastSortedCountries;

      GRID.innerHTML = '';

      if (!list.length) {
        const empty = document.createElement('div');
        empty.className = 'card';
        empty.innerHTML =
          `<div class="card-top">
             <div class="left"><div class="rank">—</div><div class="country">No results</div></div>
             <div class="score"><span>—</span></div>
           </div>
           <div class="card-body"><div class="muted">Try a different search.</div><div></div></div>`;
        GRID.appendChild(empty);
        return;
      }

      const totals = lastTotals || window.NUNC.totalsByCountry(lastLedgerPosts);

      const frag = document.createDocumentFragment();
      for (let i = 0; i < list.length; i++){
        const country = list[i];
        frag.appendChild(card(i + 1, country, totals[country] || 0));
      }
      GRID.appendChild(frag);
    }

    async function refresh(){
      try{
        const ledger = await window.NUNC.getLedger();
        lastLedgerPosts = ledger.posts || [];

        lastTotals = window.NUNC.totalsByCountry(lastLedgerPosts);
        lastSortedCountries = window.NUNC.sortCountriesByTotals(lastTotals);

        // If your sorter ever returns alphabetical (bug), harden it:
        // stable tie-break on name, but primary is boosts desc.
        lastSortedCountries.sort((a,b) => {
          const ta = Number(lastTotals[a] || 0);
          const tb = Number(lastTotals[b] || 0);
          if (tb !== ta) return tb - ta;
          return String(a).localeCompare(String(b));
        });

        render(Q.value);
      }catch(e){
        // keep whatever is currently on screen; fail silently for demo stability
        console.warn('Explore refresh failed', e);
      }
    }

    // Search + buttons
    Q.addEventListener('input', () => render(Q.value));
    CLEAR.addEventListener('click', () => { Q.value=''; render(''); });
    RANDOM.addEventListener('click', () => {
      const c = window.NUNC.rand(window.NUNC.COUNTRIES);
      Q.value = c;
      render(Q.value);
    });

    // Initial load
    refresh();

    // Live updates
    let t = null;
    const scheduleRefresh = () => {
      clearTimeout(t);
      t = setTimeout(() => refresh(), 180);
    };
    window.NUNC.watchLedger(() => scheduleRefresh(), { pollMs: 1100 });
  })();
  </script>
</body>
</html>
