<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>nunc</title>
  <link rel="stylesheet" href="./assets/app.css">
  <style>
    .feed-shell{
      width:100%;
      max-width:100%;
      margin:0;
      border:1px solid var(--hair);
      background:var(--panel);
      border-radius:0;
      overflow:hidden;
    }

    .feed-header{
      padding:18px 18px 14px;
      border-bottom:1px solid var(--hair);
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
    }

    .feed-title{
      font-size:22px;
      font-weight:600;
      margin:0;
      letter-spacing:0.1px;
    }

    .feed{display:flex;flex-direction:column;}

    .post{
      display:grid;
      grid-template-columns: 64px 1fr 44px;
      gap:14px;
      padding:16px 18px;
      border-bottom:1px solid var(--hair);
    }

    .rank{
      font-size:14px;
      color:var(--muted);
      text-align:right;
      padding-top:2px;
      white-space:nowrap;
    }

    .content{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }

    .title{
      font-size:18px;
      font-weight:600;
      line-height:1.25;
      word-wrap:break-word;
      overflow-wrap:anywhere;
    }

    .meta{
      font-size:13px;
      line-height:1.35;
      color:var(--muted);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .dot{
      width:3px;
      height:3px;
      border-radius:999px;
      background:var(--muted);
      opacity:0.6;
      display:inline-block;
      transform:translateY(-1px);
    }

    .boost{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      width:44px;
      height:36px;
      border:1px solid transparent;
      border-radius:10px;
      background:transparent;
    }

    .boost:hover{
      color:var(--text);
      border-color:var(--hair);
      background:var(--pill);
    }

    .boost::after{
      content:"boost";
      position:absolute;
      bottom:120%;
      right:0;
      padding:6px 10px;
      font-size:12px;
      color:var(--text);
      background:var(--panel2);
      border:1px solid var(--hair);
      border-radius:8px;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transform:translateY(4px);
      transition:opacity 0.15s ease, transform 0.15s ease;
    }

    .boost:hover::after{opacity:1;transform:translateY(0)}

    .feed-footer{
      padding:14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      color:var(--muted);
      font-size:13px;
      border-top:1px solid var(--hair);
      background:linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.12));
    }

    .status{
      display:flex;
      align-items:center;
      gap:10px;
      min-height:20px;
    }

    .spinner{
      width:14px;
      height:14px;
      border-radius:999px;
      border:2px solid var(--hair);
      border-top-color:rgba(255,255,255,0.55);
      animation:spin 0.8s linear infinite;
      display:none;
    }

    .loading .spinner{display:inline-block}
    @keyframes spin{to{transform:rotate(360deg)}}

    @media (max-width:520px){
      .post{grid-template-columns:56px 1fr 44px; padding:14px 14px}
      .feed-header{padding:16px 14px 12px}
      .title{font-size:17px}
    }

    .toast{
      position:fixed;
      left:50%;
      bottom:18px;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.82);
      border:1px solid var(--hair);
      padding:10px 12px;
      border-radius:12px;
      display:none;
      z-index:60;
    }

    /* payment modal (index-specific) */
    .modal-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.62);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:55;
      padding:18px;
    }

    .modal{
      width:min(560px,100%);
      border:1px solid var(--hair);
      background:linear-gradient(180deg,var(--panel),var(--panel2));
      border-radius:18px;
      box-shadow:0 18px 50px rgba(0,0,0,0.55);
      padding:16px;
    }

    .modal h2{margin:0 0 10px;font-size:20px}
    .modal .muted{color:var(--muted);font-size:14px;margin:0 0 12px}
    .modal .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0}
    .modal .grid .cell{display:flex;flex-direction:column;gap:6px}

    .modal input,.modal select{
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--hair);
      background:rgba(255,255,255,0.03);
      color:var(--text);
      font:inherit;
      font-size:16px;
      outline:none;
    }

    .modal select option{background:#161616;color:#ffffff;}

    .modal .summary{
      border:1px solid var(--hair);
      background:rgba(255,255,255,0.03);
      border-radius:14px;
      padding:10px 12px;
      display:flex;
      flex-direction:column;
      gap:6px;
      margin:10px 0 12px;
    }

    .modal .summary .line{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:14px}
    .modal .summary .line strong{color:var(--text);font-weight:700}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:10px}

    .fineprint{margin:10px 0 0;color:var(--muted);font-size:12px;line-height:1.35}
  </style>
  <script src="./assets/app.js"></script>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="nav">
        <div class="brand">
          <a class="logo" href="./index.html">nunc</a>
        </div>
        <div class="nav-actions">
          <a class="pill" href="./index.html">leaderboard</a>
          <a class="pill" href="./explore.html">explore</a>
          <a class="pill" href="./post.html">post</a>
          <a class="pill" href="./login.html">log in</a>
        </div>
      </div>
    </header>

    <main>
      <section class="feed-shell" aria-label="Global feed">
        <div class="feed-header">
          <h2 class="feed-title">Global leaderboard</h2>
        </div>

        <div id="feed" class="feed"></div>

        <div class="feed-footer" id="feedFooter">
          <div class="status" id="status">
            <span class="spinner" aria-hidden="true"></span>
            <span id="statusText">Loaded 0 posts</span>
          </div>
          <div id="hint">scroll</div>
        </div>

        <div id="sentinel" style="height:1px"></div>
      </section>
    </main>

    <footer>
      <div class="foot">
        <div>© nunc</div>
        <div>terms · transparency · ledger</div>
      </div>
    </footer>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Payment modal (used for boosts) -->
  <div class="modal-backdrop" id="payBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="payTitle">
      <h2 id="payTitle">Pay to boost</h2>
      <p class="muted">1 USD = 1 boost. Foreign currencies convert to USD at fixed demo FX rates.</p>

      <div class="grid">
        <div class="cell">
          <label for="payAmount">Amount</label>
          <input id="payAmount" inputmode="decimal" autocomplete="off" placeholder="10" />
        </div>
        <div class="cell">
          <label for="payCurrency">Currency</label>
          <select id="payCurrency">
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
            <option value="CAD">CAD</option>
            <option value="AUD">AUD</option>
            <option value="NZD">NZD</option>
            <option value="JPY">JPY</option>
            <option value="CNY">CNY</option>
            <option value="KRW">KRW</option>
            <option value="INR">INR</option>
            <option value="CHF">CHF</option>
            <option value="SEK">SEK</option>
            <option value="NOK">NOK</option>
            <option value="DKK">DKK</option>
            <option value="PLN">PLN</option>
            <option value="CZK">CZK</option>
            <option value="HUF">HUF</option>
            <option value="RON">RON</option>
            <option value="BGN">BGN</option>
            <option value="TRY">TRY</option>
            <option value="ILS">ILS</option>
            <option value="AED">AED</option>
            <option value="SAR">SAR</option>
            <option value="BRL">BRL</option>
            <option value="MXN">MXN</option>
            <option value="CLP">CLP</option>
            <option value="COP">COP</option>
            <option value="PEN">PEN</option>
            <option value="ZAR">ZAR</option>
            <option value="NGN">NGN</option>
            <option value="EGP">EGP</option>
            <option value="KES">KES</option>
            <option value="SGD">SGD</option>
            <option value="HKD">HKD</option>
            <option value="TWD">TWD</option>
            <option value="THB">THB</option>
            <option value="MYR">MYR</option>
            <option value="IDR">IDR</option>
            <option value="PHP">PHP</option>
          </select>
        </div>
      </div>

      <div class="summary">
        <div class="line"><span>FX source</span><strong id="fxSource">—</strong></div>
        <div class="line"><span>Converted</span><strong id="usdOut">—</strong></div>
        <div class="line"><span>Boosts</span><strong id="boostOut">—</strong></div>
      </div>

      <div class="actions">
        <button class="btn ghost" id="cancelPay">Cancel</button>
        <button class="btn gold" id="confirmPay">Pay & Boost</button>
      </div>

      <p class="fineprint">Static demo: shows a payment-style popup and FX conversion. No real payment is processed.</p>
    </div>
  </div>

  <script>
  (() => {
    'use strict';

    if (!window.NUNC) {
      console.error('NUNC runtime missing: include ./assets/app.js before this script.');
      return;
    }

    const FEED = document.getElementById('feed');
    const SENTINEL = document.getElementById('sentinel');
    const STATUS = document.getElementById('status');
    const STATUS_TEXT = document.getElementById('statusText');
    const TOAST = document.getElementById('toast');

    const toastMsg = (m) => {
      TOAST.textContent = m;
      TOAST.style.display = 'block';
      setTimeout(() => TOAST.style.display = 'none', 1800);
    };

    // ---------- Payment modal + FX (UI-only; deterministic demo rates) ----------
    const payBackdrop = document.getElementById('payBackdrop');
    const payAmount   = document.getElementById('payAmount');
    const payCurrency = document.getElementById('payCurrency');
    const fxSource    = document.getElementById('fxSource');
    const usdOut      = document.getElementById('usdOut');
    const boostOut    = document.getElementById('boostOut');
    const cancelPay   = document.getElementById('cancelPay');
    const confirmPay  = document.getElementById('confirmPay');

    // Demo FX rates: 1 unit of currency -> USD
    // Adjust whenever you want; correctness is "stable demo", not real-time.
    const FX_TO_USD = Object.freeze({
      USD: 1,
      EUR: 1.09,
      GBP: 1.27,
      CAD: 0.74,
      AUD: 0.67,
      NZD: 0.62,
      JPY: 0.0068,
      CNY: 0.14,
      KRW: 0.00076,
      INR: 0.012,
      CHF: 1.12,
      SEK: 0.096,
      NOK: 0.094,
      DKK: 0.15,
      PLN: 0.25,
      CZK: 0.043,
      HUF: 0.0029,
      RON: 0.22,
      BGN: 0.56,
      TRY: 0.03,
      ILS: 0.27,
      AED: 0.27,
      SAR: 0.27,
      BRL: 0.20,
      MXN: 0.058,
      CLP: 0.0011,
      COP: 0.00025,
      PEN: 0.27,
      ZAR: 0.055,
      NGN: 0.00066,
      EGP: 0.021,
      KES: 0.0067,
      SGD: 0.74,
      HKD: 0.13,
      TWD: 0.031,
      THB: 0.028,
      MYR: 0.21,
      IDR: 0.000064,
      PHP: 0.018
    });

    const parseAmount = (v)=>{
      const n = Number(String(v).replace(',','.').trim());
      return Number.isFinite(n) ? n : NaN;
    };

    function convertToUSD(amount, currency){
      const rate = FX_TO_USD[currency];
      if (!Number.isFinite(rate)) return { usd: amount, source: 'FX missing (1:1 fallback)' };
      const usd = amount * rate;
      const source = (currency === 'USD') ? 'USD (no conversion)' : 'Fixed demo FX table';
      return { usd, source };
    }

    let conversionTimer = null;
    const computeConversion = ()=>{
      clearTimeout(conversionTimer);
      conversionTimer = setTimeout(() => {
        const amt = parseAmount(payAmount.value);
        const cur = payCurrency.value;

        if(!Number.isFinite(amt) || amt <= 0){
          fxSource.textContent='—';
          usdOut.textContent='—';
          boostOut.textContent='—';
          return;
        }

        const r = convertToUSD(amt, cur);
        const boosts = Math.max(0, Math.floor(r.usd));

        fxSource.textContent = r.source;
        usdOut.textContent = r.usd.toFixed(2) + ' USD';
        boostOut.textContent = boosts + ' boosts';
      }, 80);
    };

    payAmount.addEventListener('input', computeConversion);
    payCurrency.addEventListener('change', computeConversion);

    let pendingBoostPostId = '';

    const openPay = ()=>{
      payBackdrop.style.display='flex';
      payBackdrop.setAttribute('aria-hidden','false');
      if(!payAmount.value) payAmount.value = '1';
      fxSource.textContent='—';
      usdOut.textContent='—';
      boostOut.textContent='—';
      computeConversion();
    };

    const closePay = ()=>{
      payBackdrop.style.display='none';
      payBackdrop.setAttribute('aria-hidden','true');
      pendingBoostPostId = '';
    };

    cancelPay.addEventListener('click', closePay);
    payBackdrop.addEventListener('click', (e)=>{ if(e.target === payBackdrop) closePay(); });
    document.addEventListener('keydown', (e)=>{ if(payBackdrop.style.display === 'flex' && e.key === 'Escape') closePay(); });

    async function finalizeBoost(){
      const amt = parseAmount(payAmount.value);
      const cur = payCurrency.value;
      if(!Number.isFinite(amt) || amt <= 0) return toastMsg('Payment blocked: invalid amount.');

      const r = convertToUSD(amt, cur);
      const add = Math.max(0, Math.floor(r.usd));
      if(add < 1) return toastMsg('Payment blocked: must equal at least 1 boost (>= $1).');
      if(!pendingBoostPostId) return toastMsg('Boost failed: missing post id.');

      try{
        await window.NUNC.addBoosts(pendingBoostPostId, add);
      }catch(_){
        return toastMsg('Boost failed.');
      }

      closePay();
      toastMsg('Boosted +' + add + '.');
      await renderFresh(true);
    }

    confirmPay.addEventListener('click', finalizeBoost);

    // ---------- Feed rendering (backend-first) ----------
    function setLoading(isLoading){
      if(isLoading) STATUS.classList.add('loading');
      else STATUS.classList.remove('loading');
    }

    function updateStatus(n){
      STATUS_TEXT.textContent = `Loaded ${n} posts`;
    }

    function setMetaBoostCount(metaEl, n){
      let span = metaEl.querySelector('[data-boost-count]');
      if(!span){
        const dot = document.createElement('span');
        dot.className = 'dot';
        span = document.createElement('span');
        span.setAttribute('data-boost-count','1');
        metaEl.appendChild(dot);
        metaEl.appendChild(span);
      }
      span.textContent = n + ' boosts';
    }

    function makeRow({ rank, id, text, country, timeLabel, boosts }){
      const row = document.createElement('div');
      row.className = 'post';
      row.dataset.postId = id;

      const rankEl = document.createElement('div');
      rankEl.className = 'rank';
      rankEl.textContent = `#${rank}`;

      const content = document.createElement('div');
      content.className = 'content';

      const titleEl = document.createElement('div');
      titleEl.className = 'title';
      titleEl.textContent = text;

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `${country} <span class="dot"></span> ${timeLabel}`;
      setMetaBoostCount(meta, Number(boosts || 0));

      content.appendChild(titleEl);
      content.appendChild(meta);

      const boostBtn = document.createElement('button');
      boostBtn.className = 'boost';
      boostBtn.type = 'button';
      boostBtn.setAttribute('aria-label', 'boost');
      boostBtn.textContent = '▲';
      boostBtn.addEventListener('click', ()=>{
        pendingBoostPostId = id;
        openPay();
      });

      row.appendChild(rankEl);
      row.appendChild(content);
      row.appendChild(boostBtn);

      return row;
    }

    let allPosts = [];
    let cursor = 0;
    let loaded = 0;
    const BATCH = 12;

    async function rebuildDataset(authoritative){
      // 1) paint cached immediately for speed (optional)
      if(!authoritative){
        try{
          const cached = await window.NUNC.getLedger({ preferCache: true });
          allPosts = window.NUNC.sortLeaderboardPosts((cached.posts || []).filter(p => p && p.id && p.text));
          cursor = 0;
        }catch(_){}
      }

      // 2) authoritative fetch from API
      const ledger = await window.NUNC.getLedger();
      allPosts = window.NUNC.sortLeaderboardPosts((ledger.posts || []).filter(p => p && p.id && p.text));
      cursor = 0;
    }

    function renderEmptyState(){
      FEED.innerHTML = '';
      loaded = 0;
      updateStatus(loaded);
      const row = document.createElement('div');
      row.className = 'post';
      row.innerHTML = `
        <div class="rank">—</div>
        <div class="content">
          <div class="title">No posts yet</div>
          <div class="meta">Create a post on the post page.</div>
        </div>
        <div></div>
      `;
      FEED.appendChild(row);
    }

    function appendBatch(){
      if(cursor >= allPosts.length) return;
      setLoading(true);

      window.setTimeout(() => {
        const frag = document.createDocumentFragment();
        const startRank = cursor + 1;

        for(let i=0;i<BATCH && cursor < allPosts.length;i++, cursor++){
          const p = allPosts[cursor];
          frag.appendChild(makeRow({
            rank: startRank + i,
            id: p.id,
            text: String(p.text).slice(0,200),
            country: p.country || '—',
            timeLabel: p.createdAt ? window.NUNC.fmtTimeAgo(p.createdAt) : '—',
            boosts: Number(p.boosts || 0)
          }));
          loaded++;
        }

        FEED.appendChild(frag);
        updateStatus(loaded);
        setLoading(false);
      }, 80);
    }

    let inFlight = false;
    async function renderFresh(authoritative){
      if(inFlight) return;
      inFlight = true;
      setLoading(true);

      try{
        FEED.innerHTML = '';
        loaded = 0;
        updateStatus(0);

        await rebuildDataset(!!authoritative);

        if(allPosts.length === 0){
          renderEmptyState();
        }else{
          appendBatch();
        }
      }catch(_){
        renderEmptyState();
        toastMsg('Load failed (API unreachable).');
      }finally{
        setLoading(false);
        inFlight = false;
      }
    }

    // Initial: show cache fast, then authoritative
    (async () => {
      await renderFresh(false);
    })();

    const io = new IntersectionObserver((entries) => {
      for(const e of entries){
        if(e.isIntersecting) appendBatch();
      }
    }, { root:null, rootMargin:'600px 0px', threshold:0 });

    io.observe(SENTINEL);

    // Debounced refresh to avoid hammering API on frequent events
    let refreshTimer = null;
    const scheduleRefresh = () => {
      clearTimeout(refreshTimer);
      refreshTimer = setTimeout(() => renderFresh(true), 180);
    };

    window.NUNC.watchLedger((e) => {
  const d = e?.detail || e || {};
  const op = d?.op;
  if (op === 'ledger_refresh') return; // ignore reads; only react to mutations
  scheduleRefresh();
}, { pollMs: 900 });
  </script>
</body>
</html>
