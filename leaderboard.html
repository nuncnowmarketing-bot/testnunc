<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>nunc</title>
  <style>
    :root{
      --bg:#121212;
      --panel:#161616;
      --panel2:#1b1b1b;
      --text:#ffffff;
      --muted:rgba(255,255,255,0.70);
      --hair:rgba(255,255,255,0.12);
      --pill:rgba(255,255,255,0.06);
      --pillHover:rgba(255,255,255,0.10);
      --danger:rgba(255,255,255,0.08);
      --gold:#d4af37;
      --goldBg:rgba(212,175,55,0.15);
      --goldHover:rgba(212,175,55,0.25);
    }

    *{box-sizing:border-box}
    html,body{
      margin:0;
      min-height:100vh;
      background:transparent; /* painted by fixed layer below */
      color:var(--text);
      font-family:Garamond,"EB Garamond","Cormorant Garamond","Times New Roman",serif;
      letter-spacing:0.2px;
      position:relative;
    }

    /* Always-dark viewport background (prevents white gutters/overscroll in embeds/previews) */
    body::before{
      content:"";
      position:fixed;
      inset:0;
      background:var(--bg);
      z-index:-1;
    }

    a{color:inherit;text-decoration:none}

    .wrap{
      min-height:100%;
      display:flex;
      flex-direction:column;
    }

    header{
      position:sticky;
      top:0;
      background:rgba(18,18,18,0.94);
      border-bottom:1px solid var(--hair);
      z-index:10;
      backdrop-filter:saturate(140%) blur(8px);
    }

    .nav{
      max-width:1080px;
      margin:0 auto;
      padding:18px 20px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .brand{display:flex;align-items:baseline;gap:12px}

    .logo{
      font-size:30px;
      font-weight:600;
      line-height:1;
    }

    .nav-actions{display:flex;gap:10px}

    .pill{
      padding:8px 14px;
      border:1px solid var(--hair);
      border-radius:999px;
      background:var(--pill);
      font-size:14px;
      font-family:inherit;
      display:inline-block;
    }

    .pill:hover{background:var(--pillHover)}

    main{
      flex:1;
      width:100%;
      max-width:1280px;
      margin:0 auto;
      padding:18px 20px 56px;
      display:block;
    }

    /* Feed shell (Twitter/Threads-like: dense, scroll-first) */
    .feed-shell{
      width:100%;
      max-width:100%;
      margin:0;
      border-left:1px solid var(--hair);
      border-right:1px solid var(--hair);
      border-top:1px solid var(--hair);
      border-bottom:1px solid var(--hair);
      background:var(--panel);
      border-radius:0;
      overflow:hidden;
    }

    .feed-header{
      padding:18px 18px 14px;
      border-bottom:1px solid var(--hair);
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:12px;
    }

    .feed-title{
      font-size:22px;
      font-weight:600;
      margin:0;
      letter-spacing:0.1px;
    }

    .feed{
      display:flex;
      flex-direction:column;
    }

    .post{
      display:grid;
      grid-template-columns: 64px 1fr 44px;
      gap:14px;
      padding:16px 18px;
      border-bottom:1px solid var(--hair);
    }

    .rank{
      font-size:14px;
      color:var(--muted);
      text-align:right;
      padding-top:2px;
      white-space:nowrap;
    }

    .content{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width:0;
    }

    .title{
      font-size:18px;
      font-weight:600;
      line-height:1.25;
      word-wrap:break-word;
      overflow-wrap:anywhere;
    }

    .meta{
      font-size:13px;
      line-height:1.35;
      color:var(--muted);
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      align-items:center;
    }

    .dot{
      width:3px;
      height:3px;
      border-radius:999px;
      background:var(--muted);
      opacity:0.6;
      display:inline-block;
      transform:translateY(-1px);
    }

    .boost{
      position:relative;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:18px;
      color:var(--muted);
      cursor:pointer;
      user-select:none;
      width:44px;
      height:36px;
      border:1px solid transparent;
      border-radius:10px;
      background:transparent;
    }

    .boost:hover{
      color:var(--text);
      border-color:var(--hair);
      background:var(--pill);
    }

    .boost::after{
      content:"boost";
      position:absolute;
      bottom:120%;
      right:0;
      padding:6px 10px;
      font-size:12px;
      color:var(--text);
      background:var(--panel2);
      border:1px solid var(--hair);
      border-radius:8px;
      white-space:nowrap;
      opacity:0;
      pointer-events:none;
      transform:translateY(4px);
      transition:opacity 0.15s ease, transform 0.15s ease;
    }

    .boost:hover::after{opacity:1;transform:translateY(0)}

    .feed-footer{
      padding:14px 18px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      color:var(--muted);
      font-size:13px;
      border-top:1px solid var(--hair);
      background:linear-gradient(to bottom, rgba(0,0,0,0), rgba(0,0,0,0.12));
    }

    .status{
      display:flex;
      align-items:center;
      gap:10px;
      min-height:20px;
    }

    .spinner{
      width:14px;
      height:14px;
      border-radius:999px;
      border:2px solid var(--hair);
      border-top-color:rgba(255,255,255,0.55);
      animation:spin 0.8s linear infinite;
      display:none;
    }

    .loading .spinner{display:inline-block}

    @keyframes spin{to{transform:rotate(360deg)}}

    footer{
      border-top:1px solid var(--hair);
      background:var(--panel);
    }

    /* Prevent white "rubber-band" overscroll in some previews */
    @supports (-webkit-touch-callout: none){
      html, body{background:var(--bg);}
    }

    .foot{
      max-width:1080px;
      margin:0 auto;
      padding:20px;
      font-size:13px;
      color:var(--muted);
      display:flex;
      justify-content:space-between;
    }

    /* Mobile tightening */
    @media (max-width:520px){
      main{padding:12px 12px 48px}
      .post{grid-template-columns:56px 1fr 44px; padding:14px 14px}
      .feed-header{padding:16px 14px 12px}
      .title{font-size:17px}
    }

    /* shared button styles (modal) */
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border:1px solid var(--hair);background:var(--pill);border-radius:999px;cursor:pointer;font:inherit;color:var(--text)}
    .btn:hover{background:var(--pillHover)}
    .btn.gold{border-color:var(--gold);background:var(--goldBg);color:var(--gold);font-weight:700}
    .btn.gold:hover{background:var(--goldHover)}
    .btn.ghost{background:transparent}

    .toast{position:fixed;left:50%;bottom:18px;transform:translateX(-50%);background:rgba(0,0,0,0.82);border:1px solid var(--hair);padding:10px 12px;border-radius:12px;display:none;z-index:60}

    /* payment modal (copied from post page) */
    .modal-backdrop{position:fixed;inset:0;background:rgba(0,0,0,0.62);display:none;align-items:center;justify-content:center;z-index:55;padding:18px;}
    .modal{width:min(560px,100%);border:1px solid var(--hair);background:linear-gradient(180deg,var(--panel),var(--panel2));border-radius:18px;box-shadow:0 18px 50px rgba(0,0,0,0.55);padding:16px;}
    .modal h2{margin:0 0 10px;font-size:20px}
    .modal .muted{color:var(--muted);font-size:14px;margin:0 0 12px}
    .modal .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0}
    .modal .grid .cell{display:flex;flex-direction:column;gap:6px}
    .modal input,.modal select{padding:10px 12px;border-radius:14px;border:1px solid var(--hair);background:rgba(255,255,255,0.03);color:var(--text);font:inherit;font-size:16px;outline:none;}
    .modal select option{background:#161616;color:#ffffff;}
    .modal .summary{border:1px solid var(--hair);background:rgba(255,255,255,0.03);border-radius:14px;padding:10px 12px;display:flex;flex-direction:column;gap:6px;margin:10px 0 12px;}
    .modal .summary .line{display:flex;justify-content:space-between;gap:10px;color:var(--muted);font-size:14px}
    .modal .summary .line strong{color:var(--text);font-weight:700}
    .modal .actions{display:flex;gap:10px;justify-content:flex-end;flex-wrap:wrap;margin-top:10px}
    .fineprint{margin:10px 0 0;color:var(--muted);font-size:12px;line-height:1.35}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div class="nav">
        <div class="brand">
          <a class="logo" href="./leaderboard.html">nunc</a>
        </div>
        <div class="nav-actions">
          <a class="pill" href="./leaderboard.html">leaderboard</a>
          <a class="pill" href="./explore.html">explore</a>
          <a class="pill" href="./post.html">post</a>
          <a class="pill" href="./login.html">log in</a>
        </div>
      </div>
    </header>

    <main>
      <section class="feed-shell" aria-label="Global feed">
        <div class="feed-header">
          <h2 class="feed-title">Global leaderboard</h2>
        </div>

        <div id="feed" class="feed"></div>

        <div class="feed-footer" id="feedFooter">
          <div class="status" id="status">
            <span class="spinner" aria-hidden="true"></span>
            <span id="statusText">Loaded 0 posts</span>
          </div>
          <div id="hint">scroll</div>
        </div>

        <div id="sentinel" style="height:1px"></div>
      </section>
    </main>

    <footer>
      <div class="foot">
        <div>© nunc</div>
        <div>terms · transparency · ledger</div>
      </div>
    </footer>
  </div>

  <div class="toast" id="toast"></div>

  <!-- Payment modal (used for boosts) -->
  <div class="modal-backdrop" id="payBackdrop" aria-hidden="true">
    <div class="modal" role="dialog" aria-modal="true" aria-labelledby="payTitle">
      <h2 id="payTitle">Pay to boost</h2>
      <p class="muted">1 USD = 1 boost. Foreign currencies convert to USD at live FX rates.</p>

      <div class="grid">
        <div class="cell">
          <label for="payAmount">Amount</label>
          <input id="payAmount" inputmode="decimal" autocomplete="off" placeholder="10" />
        </div>
        <div class="cell">
          <label for="payCurrency">Currency</label>
          <select id="payCurrency">
            <option value="USD">USD</option>
            <option value="EUR">EUR</option>
            <option value="GBP">GBP</option>
            <option value="CAD">CAD</option>
            <option value="AUD">AUD</option>
            <option value="NZD">NZD</option>
            <option value="JPY">JPY</option>
            <option value="CNY">CNY</option>
            <option value="KRW">KRW</option>
            <option value="INR">INR</option>
            <option value="CHF">CHF</option>
            <option value="SEK">SEK</option>
            <option value="NOK">NOK</option>
            <option value="DKK">DKK</option>
            <option value="PLN">PLN</option>
            <option value="CZK">CZK</option>
            <option value="HUF">HUF</option>
            <option value="RON">RON</option>
            <option value="BGN">BGN</option>
            <option value="TRY">TRY</option>
            <option value="ILS">ILS</option>
            <option value="AED">AED</option>
            <option value="SAR">SAR</option>
            <option value="BRL">BRL</option>
            <option value="MXN">MXN</option>
            <option value="CLP">CLP</option>
            <option value="COP">COP</option>
            <option value="PEN">PEN</option>
            <option value="ZAR">ZAR</option>
            <option value="NGN">NGN</option>
            <option value="EGP">EGP</option>
            <option value="KES">KES</option>
            <option value="SGD">SGD</option>
            <option value="HKD">HKD</option>
            <option value="TWD">TWD</option>
            <option value="THB">THB</option>
            <option value="MYR">MYR</option>
            <option value="IDR">IDR</option>
            <option value="PHP">PHP</option>
          </select>
        </div>
      </div>

      <div class="summary">
        <div class="line"><span>FX source</span><strong id="fxSource">—</strong></div>
        <div class="line"><span>Converted</span><strong id="usdOut">—</strong></div>
        <div class="line"><span>Boosts</span><strong id="boostOut">—</strong></div>
      </div>

      <div class="actions">
        <button class="btn ghost" id="cancelPay">Cancel</button>
        <button class="btn gold" id="confirmPay">Pay & Boost</button>
      </div>

      <p class="fineprint">Static demo: shows a payment-style popup and FX conversion. No real payment is processed.</p>
    </div>
  </div>

  <script>
    // Twitter/Threads-like feed behavior: render in batches; append when sentinel enters viewport.
    // For now: 50 sample posts, but infinite loading loop by recycling generated content.

    const FEED = document.getElementById('feed');
    const SENTINEL = document.getElementById('sentinel');
    const STATUS = document.getElementById('status');
    const STATUS_TEXT = document.getElementById('statusText');
    const TOAST = document.getElementById('toast');

    const countries = [
      'Japan','Germany','Brazil','Canada','South Africa','Ireland','France','Spain','Italy','Netherlands',
      'Sweden','Norway','Denmark','Finland','Poland','Czechia','Portugal','Greece','Turkey','Egypt',
      'Nigeria','Kenya','Morocco','India','Pakistan','Bangladesh','Thailand','Vietnam','Indonesia','Philippines',
      'Australia','New Zealand','Mexico','Argentina','Chile','Colombia','Peru','United States','United Kingdom','Switzerland',
      'Austria','Belgium','Hungary','Romania','Bulgaria','Ukraine','Israel','UAE','Saudi Arabia','Singapore'
    ];

    const prompts = [
      'Conviction beats correctness when incentives are misaligned.',
      'If a platform hides the price, it is selling you to someone else.',
      'Attention is a budget. Most people spend it like it is infinite.',
      'Transparency hurts because it removes narratives.',
      'Markets pay for confidence, then punish for being wrong.',
      'If you cannot explain it simply, you are outsourcing thinking.',
      'Most "debates" are status games disguised as logic.',
      'The algorithm is not neutral. It is a business model.',
      'Outrage is a distribution strategy.',
      'The easiest way to win is to choose games with honest scoring.',
      'Clarity is expensive. Vagueness is subsidised.',
      'Every system optimises for what it measures, not what it claims to value.',
      'Most people confuse confidence with competence.',
      'Visibility without accountability produces noise.',
      'Incentives explain behaviour better than morality.'
    ];

    const timeLabels = ['just now','1m','3m','6m','10m','18m','25m','40m','1h','2h','4h','7h','12h','18h','23h'];

    function rand(arr){ return arr[Math.floor(Math.random()*arr.length)]; }

    function randomText(maxChars){
      let out = '';
      while(out.length < maxChars){
        const next = rand(prompts);
        if(out.length + next.length + 1 > maxChars) break;
        out += (out ? ' ' : '') + next;
      }
      if(out.length === 0) out = rand(prompts);
      return out;
    }

    // -------------------- boost payment modal logic (copied behavior) --------------------
    const BOOSTS_KEY = 'nunc_boosts_v1'; // { [postId]: number }

    const payBackdrop = document.getElementById('payBackdrop');
    const payAmount   = document.getElementById('payAmount');
    const payCurrency = document.getElementById('payCurrency');
    const fxSource    = document.getElementById('fxSource');
    const usdOut      = document.getElementById('usdOut');
    const boostOut    = document.getElementById('boostOut');
    const cancelPay   = document.getElementById('cancelPay');
    const confirmPay  = document.getElementById('confirmPay');

    const toastMsg=m=>{TOAST.textContent=m;TOAST.style.display='block';setTimeout(()=>TOAST.style.display='none',1800)};

    const parseAmount = (v)=>{
      const n = Number(String(v).replace(',','.').trim());
      return Number.isFinite(n) ? n : NaN;
    };

    async function convertToUSD(amount, currency){
      if(currency === 'USD') return { usd: amount, source: 'USD (no conversion)' };
      const url = 'https://api.frankfurter.app/latest?amount=' + encodeURIComponent(amount) +
                  '&from=' + encodeURIComponent(currency) + '&to=USD';
      try{
        const res = await fetch(url, { cache:'no-store' });
        if(!res.ok) throw new Error('fx_http_'+res.status);
        const data = await res.json();
        const usd = data && data.rates && typeof data.rates.USD === 'number' ? data.rates.USD : NaN;
        if(!Number.isFinite(usd)) throw new Error('fx_parse');
        return { usd, source: 'Frankfurter (ECB)' };
      }catch(_){
        return { usd: amount, source: 'FX unavailable (1:1 fallback)' };
      }
    }

    let conversionTimer = null;
    const computeConversion = ()=>{
      clearTimeout(conversionTimer);
      conversionTimer = setTimeout(async ()=>{
        const amt = parseAmount(payAmount.value);
        const cur = payCurrency.value;

        if(!Number.isFinite(amt) || amt <= 0){
          fxSource.textContent='—';
          usdOut.textContent='—';
          boostOut.textContent='—';
          return;
        }

        fxSource.textContent='Converting…';
        usdOut.textContent='…';
        boostOut.textContent='…';

        const r = await convertToUSD(amt, cur);
        const usd = r.usd;

        // cents discarded (always floor)
        const boosts = Math.max(0, Math.floor(usd));

        fxSource.textContent = r.source;
        usdOut.textContent = usd.toFixed(2) + ' USD';
        boostOut.textContent = boosts + ' boosts';
      }, 120);
    };

    payAmount.addEventListener('input', computeConversion);
    payCurrency.addEventListener('change', computeConversion);

    const openPay = ()=>{
      payBackdrop.style.display='flex';
      payBackdrop.setAttribute('aria-hidden','false');
      if(!payAmount.value) payAmount.value = '1';
      fxSource.textContent='—';
      usdOut.textContent='—';
      boostOut.textContent='—';
      computeConversion();
    };

    const closePay = ()=>{
      payBackdrop.style.display='none';
      payBackdrop.setAttribute('aria-hidden','true');
      pendingBoostPostId = '';
      pendingBoostMetaEl = null;
    };

    cancelPay.addEventListener('click', closePay);
    payBackdrop.addEventListener('click', (e)=>{ if(e.target === payBackdrop) closePay(); });
    document.addEventListener('keydown', (e)=>{ if(payBackdrop.style.display === 'flex' && e.key === 'Escape') closePay(); });

    const loadBoosts = ()=>{
      try{ return JSON.parse(localStorage.getItem(BOOSTS_KEY) || '{}') || {}; }
      catch(_){ return {}; }
    };
    const saveBoosts = (m)=>localStorage.setItem(BOOSTS_KEY, JSON.stringify(m));

    let pendingBoostPostId = '';
    let pendingBoostMetaEl = null;

    function setMetaBoostCount(metaEl, n){
      // meta layout: country · time · X boosts
      let span = metaEl.querySelector('[data-boost-count]');
      if(!span){
        const dot = document.createElement('span');
        dot.className = 'dot';
        span = document.createElement('span');
        span.setAttribute('data-boost-count','1');
        metaEl.appendChild(dot);
        metaEl.appendChild(span);
      }
      span.textContent = n + ' boosts';
    }

    async function finalizeBoost(){
      const amt = parseAmount(payAmount.value);
      const cur = payCurrency.value;
      if(!Number.isFinite(amt) || amt <= 0) return toastMsg('Payment blocked: invalid amount.');

      const r = await convertToUSD(amt, cur);
      const add = Math.max(0, Math.floor(r.usd));
      if(add < 1) return toastMsg('Payment blocked: must equal at least 1 boost (>= $1).');
      if(!pendingBoostPostId) return toastMsg('Boost failed: missing post id.');

      const map = loadBoosts();
      const prev = Number(map[pendingBoostPostId] || 0);
      const next = prev + add;
      map[pendingBoostPostId] = next;
      saveBoosts(map);

      if(pendingBoostMetaEl) setMetaBoostCount(pendingBoostMetaEl, next);

      closePay();
      toastMsg('Boosted +'+add+'.');
    }

    confirmPay.addEventListener('click', finalizeBoost);

    // -------------------- feed rendering --------------------
    function makePost(rank){
      const id = Math.random().toString(36).slice(2) + Date.now().toString(36);

      const maxLen = Math.floor(Math.random() * 200) + 1; // 1–200 chars
      const title = randomText(maxLen).slice(0, maxLen);
      const country = rand(countries);
      const t = rand(timeLabels);

      const row = document.createElement('div');
      row.className = 'post';
      row.dataset.postId = id;

      const rankEl = document.createElement('div');
      rankEl.className = 'rank';
      rankEl.textContent = `#${rank}`;

      const content = document.createElement('div');
      content.className = 'content';

      const titleEl = document.createElement('div');
      titleEl.className = 'title';
      titleEl.textContent = title;

      const meta = document.createElement('div');
      meta.className = 'meta';
      meta.innerHTML = `${country} <span class="dot"></span> ${t}`;

      // apply saved boosts (if any)
      const saved = loadBoosts();
      const count = Number(saved[id] || 0);
      if(count > 0) setMetaBoostCount(meta, count);

      content.appendChild(titleEl);
      content.appendChild(meta);

      const boost = document.createElement('button');
      boost.className = 'boost';
      boost.type = 'button';
      boost.setAttribute('aria-label', 'boost');
      boost.textContent = '▲';

      boost.addEventListener('click', ()=>{
        pendingBoostPostId = id;
        pendingBoostMetaEl = meta;
        openPay();
      });

      row.appendChild(rankEl);
      row.appendChild(content);
      row.appendChild(boost);

      return row;
    }

    let nextRank = 1;
    let loaded = 0;
    const BATCH = 12;

    function setLoading(isLoading){
      if(isLoading) STATUS.classList.add('loading');
      else STATUS.classList.remove('loading');
    }

    function updateStatus(){
      STATUS_TEXT.textContent = `Loaded ${loaded} posts`;
    }

    function appendBatch(){
      setLoading(true);
      window.setTimeout(() => {
        const frag = document.createDocumentFragment();
        for(let i=0;i<BATCH;i++){
          const node = makePost(nextRank);
          frag.appendChild(node);
          nextRank++;
          loaded++;
        }
        FEED.appendChild(frag);
        updateStatus();
        setLoading(false);
      }, 220);
    }

    appendBatch();
    appendBatch();

    const io = new IntersectionObserver((entries) => {
      for(const e of entries){
        if(e.isIntersecting){
          appendBatch();
        }
      }
    }, { root:null, rootMargin:'600px 0px', threshold:0 });

    io.observe(SENTINEL);
    updateStatus();
  </script>
</body>
</html>
